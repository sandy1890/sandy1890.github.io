<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="sandy1890, 码农，PHP程序,DCT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="安迪桑的笔记">
<meta property="og:url" content="https://blog.sandy1890.com/index.html">
<meta property="og:site_name" content="安迪桑的笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="安迪桑的笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="https://blog.sandy1890.com/"/>





  <title>安迪桑的笔记</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">安迪桑的笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2017/02/09/logs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/09/logs/" itemprop="url">日志收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="php错误日志"><a href="#php错误日志" class="headerlink" title="php错误日志"></a>php错误日志</h2><h3 id="php-ini"><a href="#php-ini" class="headerlink" title="php.ini"></a>php.ini</h3><p>log_erros<br>log_erros_max_len<br>error_log<br>display_errors</p>
<h3 id="php-fpm-conf"><a href="#php-fpm-conf" class="headerlink" title="php-fpm.conf"></a>php-fpm.conf</h3><p>slowlog<br>request_slowlog_timeout<br>access.log</p>
<h2 id="ngin访问日志"><a href="#ngin访问日志" class="headerlink" title="ngin访问日志"></a>ngin访问日志</h2><h2 id="日志切割"><a href="#日志切割" class="headerlink" title="日志切割"></a>日志切割</h2><h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><h3 id="logrotate-ˈroʊteɪt"><a href="#logrotate-ˈroʊteɪt" class="headerlink" title="logrotate [ˈroʊteɪt]"></a>logrotate [ˈroʊteɪt]</h3><h2 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h2><h4 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h4><h4 id="kafka-‘ka-fka"><a href="#kafka-‘ka-fka" class="headerlink" title="kafka[‘ka:fka:]"></a>kafka[‘ka:fka:]</h4><h4 id="Scribe-skraɪb"><a href="#Scribe-skraɪb" class="headerlink" title="Scribe[skraɪb]"></a>Scribe[skraɪb]</h4><h4 id="flume-flum"><a href="#flume-flum" class="headerlink" title="flume[flum]"></a>flume[flum]</h4><h2 id="日志存储"><a href="#日志存储" class="headerlink" title="日志存储"></a>日志存储</h2><h4 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a>Hadoop</h4><h4 id="Spark"><a href="#Spark" class="headerlink" title="Spark"></a>Spark</h4><h4 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h4>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/12/02/go_study_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/02/go_study_01/" itemprop="url">Go学习01 -- 环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装下载"><a href="#安装下载" class="headerlink" title="安装下载"></a>安装下载</h3><p><a href="https://golang.org/dl/" target="_blank" rel="external">官网</a> 下载自己机器系统对应的二进制安装包，解压到相应目录.</p>
<p>解压目录说明：</p>
<ul>
<li>Linux 和 Mac OS　系统通常解压到 <code>/usr/local/go</code></li>
<li>Windows 系统通常解压到 <code>c:\Go</code> 目录</li>
</ul>
<p>本次安装过程实际在 Ubuntu 机器上执行的命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#tar -C /usr/local -xzf go$VERSION.$OS-$ARCH.tar.gz</span></div><div class="line">sudo tar -C /usr/<span class="built_in">local</span> -xzf go1.7.4.linux-amd64.tar.gz</div></pre></td></tr></table></figure>
<h3 id="环境变量设置"><a href="#环境变量设置" class="headerlink" title="环境变量设置"></a>环境变量设置</h3><ul>
<li>在系统 PATH 环境变量里添加　 /usr/local/go/bin </li>
<li>GOROOT变量指向go安装目录，默认通常为 <code>/usr/local/go</code> 或 <code>c:\Go</code>,需要根据实际安装情况自行调整</li>
<li>GOPATH 是用来设置包加载路径的重要变量，当在命令行运行 go build, go get 等命令时会需要该变量。这个变量通常指向你的工作空间（go项目代码存放位置）目录，这里假设你的工作空间为 $HOME/work (实际开发过程中为了方便管理项目，通常在项目自定义脚本中设置 GOPATH 和编译打包，省去每新增一个项目都需要修改 GOPATH 变量的麻烦，参见下文)</li>
</ul>
<p>本将安装过程 Ubuntu 机器上新建 <code>/etc/profile.d/go.sh</code> 文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go</div><div class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/work</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin</div></pre></td></tr></table></figure>
<p>创建完go.sh文件后，注销用户重新登录或是运行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> /etc/profile</div></pre></td></tr></table></figure>
<p>注：关于环境变量相关的设置，需要了解各平台相关知识，这里不细述，自行百度或谷歌</p>
<h3 id="Go-项目目录结构"><a href="#Go-项目目录结构" class="headerlink" title="Go 项目目录结构"></a>Go 项目目录结构</h3><p>一个 Go 程序项目一般包含三个目录</p>
<ul>
<li>src 目录存放go程序源文件,程序源文件按包组织（通常每个目录都对应一个包）</li>
<li>pkg 目录包含包对象</li>
<li>bin 目录包含可执行命令</li>
</ul>
<p>一个工作空间目录结构看起来像这样:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">bin/</div><div class="line">    streak                         <span class="comment"># 可执行命令</span></div><div class="line">    todo                           <span class="comment"># 可执行命令</span></div><div class="line">pkg/</div><div class="line">    linux_amd64/</div><div class="line">        code.google.com/p/goauth2/</div><div class="line">            oauth.a                <span class="comment"># 包对象</span></div><div class="line">        github.com/nf/todo/</div><div class="line">            task.a                 <span class="comment"># 包对象</span></div><div class="line">src/</div><div class="line">    code.google.com/p/goauth2/</div><div class="line">        .hg/                       <span class="comment"># mercurial 代码库元数据</span></div><div class="line">        oauth/</div><div class="line">            oauth.go               <span class="comment"># 包源码</span></div><div class="line">            oauth_test.go          <span class="comment"># 测试源码</span></div><div class="line">    github.com/nf/</div><div class="line">        streak/</div><div class="line">        .git/                      <span class="comment"># git 代码库元数据</span></div><div class="line">            oauth.go               <span class="comment"># 命令源码</span></div><div class="line">            streak.go              <span class="comment"># 命令源码</span></div><div class="line">        todo/</div><div class="line">        .git/                      <span class="comment"># git 代码库元数据</span></div><div class="line">            task/</div><div class="line">                task.go            <span class="comment"># 包源码</span></div><div class="line">            todo.go                <span class="comment"># 命令源码</span></div></pre></td></tr></table></figure>
<p>此工作空间包含三个代码库（goauth2、streak 和 todo），两个命令（streak 和 todo） 以及两个库（oauth 和 task）。</p>
<h3 id="项目-GOPATH-设置脚本"><a href="#项目-GOPATH-设置脚本" class="headerlink" title="项目 GOPATH 设置脚本"></a>项目 GOPATH 设置脚本</h3><p>前面介绍环境变量 GOPATH 的时候提到，为了避免每次新建一个项目都去修改系统环境变量的麻烦。我们可以使用一个脚本来设置特定项目的 GOPATH 变量。</p>
<p>install.sh 脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="keyword">if</span> [ ! -f install.sh ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'安装脚本必须在项目根目录中运行'</span> 1&gt;&amp;2</div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="comment">#获取当前项目目录</span></div><div class="line">CURDIR=`<span class="built_in">pwd</span>`</div><div class="line"><span class="comment">#获取系统设置的 GOPATH</span></div><div class="line">OLDGOPATH=<span class="string">"<span class="variable">$GOPATH</span>"</span></div><div class="line"><span class="comment">#将GOPATH设置为当前项目</span></div><div class="line"><span class="built_in">export</span> GOPATH=<span class="string">"<span class="variable">$CURDIR</span>"</span></div><div class="line"></div><div class="line"><span class="comment">#以下为特定项目编译需要运行的命令</span></div><div class="line">gofmt -w src</div><div class="line">go build -o bin/hello src/hello.go</div><div class="line"><span class="comment">#以上为特定项目命令</span></div><div class="line"></div><div class="line"><span class="comment">#还原系统GOPATH变量值</span></div><div class="line"><span class="built_in">export</span> GOPATH=<span class="string">"<span class="variable">$OLDGOPATH</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'编译完成'</span></div></pre></td></tr></table></figure>
<p>Windows 下的 install.bat 脚本(未验证):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@<span class="built_in">echo</span> off</div><div class="line"></div><div class="line">setlocal</div><div class="line"></div><div class="line"><span class="keyword">if</span> exist install.bat goto ok</div><div class="line">    <span class="built_in">echo</span> 安装脚本 install.bat 必须在项目根目录中运行</div><div class="line">goto end</div><div class="line"></div><div class="line">: ok</div><div class="line"></div><div class="line"><span class="built_in">set</span> OLDGOPATH=%GOPATH%</div><div class="line"><span class="built_in">set</span> GOPATH=%~dp0</div><div class="line"></div><div class="line">gofmt -w src</div><div class="line">go build -o bin/hello src/hello.go</div><div class="line"></div><div class="line">:end</div><div class="line"><span class="built_in">echo</span> 编译完成</div></pre></td></tr></table></figure>
<h3 id="hello-world"><a href="#hello-world" class="headerlink" title="hello,world"></a>hello,world</h3><p>通过之前的介绍，现在我们来写一个hello,world的例子</p>
<ul>
<li>项目目录结构如下:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">helloworld/</div><div class="line">├── bin</div><div class="line">│   └── hello</div><div class="line">├── install.sh</div><div class="line">├── pkg</div><div class="line">└── src</div><div class="line">    └── hello.go</div></pre></td></tr></table></figure>
<ul>
<li>编写 <code>src\hello.go</code> 文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"你好，世界.\n"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编写 <code>install.sh</code> 文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="keyword">if</span> [ ! -f install.sh ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'安装脚本必须在项目根目录中运行'</span> 1&gt;&amp;2</div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="comment">#获取当前项目目录</span></div><div class="line">CURDIR=`<span class="built_in">pwd</span>`</div><div class="line"><span class="comment">#获取系统设置的 GOPATH</span></div><div class="line">OLDGOPATH=<span class="string">"<span class="variable">$GOPATH</span>"</span></div><div class="line"><span class="comment">#将GOPATH设置为当前项目</span></div><div class="line"><span class="built_in">export</span> GOPATH=<span class="string">"<span class="variable">$CURDIR</span>"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#以下为特定项目编译需要运行的命令</span></div><div class="line">gofmt -w src</div><div class="line">go build -o bin/hello src/hello.go</div><div class="line"><span class="comment">#以上为特定项目命令</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#还原系统GOPATH变量值</span></div><div class="line"><span class="built_in">export</span> GOPATH=<span class="string">"<span class="variable">$OLDGOPATH</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'编译完成'</span></div></pre></td></tr></table></figure>
<ul>
<li>编译<br>编写完上面的文件之后，让我们进到项目根目录运行 helloworld程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> helloworld</div><div class="line"><span class="comment">#编译</span></div><div class="line">sh install.sh</div><div class="line"><span class="comment">#运行</span></div><div class="line">./bin/hello</div><div class="line"><span class="comment">#此时你应该能在终端看到如下输出</span></div><div class="line">你好，世界.</div></pre></td></tr></table></figure>
<h3 id="本地运行Go自带的学习资源"><a href="#本地运行Go自带的学习资源" class="headerlink" title="本地运行Go自带的学习资源"></a>本地运行Go自带的学习资源</h3><ul>
<li><p>离线运行官方文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">godoc -http=:8080 -v</div></pre></td></tr></table></figure>
</li>
<li><p>离线运行官方入门学习教程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go tool tour</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考资源：<br><a href="http://docscn.studygolang.com/doc/install" target="_blank" rel="external">官方文档中文版</a><br><a href="http://blog.studygolang.com/2012/12/go%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/" target="_blank" rel="external">Go项目的目录结构</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/10/31/react_key/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/31/react_key/" itemprop="url">React基础－－key</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="React列表"><a href="#React列表" class="headerlink" title="React列表"></a>React列表</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/10/23/pptpd_iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/23/pptpd_iptables/" itemprop="url">CentOS 7 使用 pptpd 搭建 VPN 的 iptables 配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="pptpd设置"><a href="#pptpd设置" class="headerlink" title="pptpd设置"></a>pptpd设置</h2><p>主要会操作三个配置文件：</p>
<ul>
<li>主服务配置文件 <code>/etc/pptpd.conf</code></li>
<li>DNS等选项配置文件 <code>/etc/ppp/options.pptpd</code></li>
<li>用户授权配置文件 <code>/etc/ppp/chap-secrets</code></li>
</ul>
<h3 id="pptpd服务配置"><a href="#pptpd服务配置" class="headerlink" title="pptpd服务配置"></a>pptpd服务配置</h3><p>编辑 <code>/etc/pptpd.conf</code> 去掉前面的#去掉：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">localip <span class="number">192.168</span><span class="number">.1</span></div><div class="line">remoteip <span class="number">192.168</span><span class="number">.1</span><span class="number">.234</span><span class="number">-238</span>,<span class="number">192.168</span><span class="number">.1</span><span class="number">.245</span></div></pre></td></tr></table></figure></p>
<p>解释下: localip是pptp使用的ip, 可以随意; remoteip链接到vpn的用户分配到ip的访问, 和localip同一个网段即可.</p>
<h3 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h3><p>编辑 <code>/etc/ppp/options.pptpd</code> 去掉ms-dns前面的#，修改成下面的数据：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ms-dns 8.8.8.8</div><div class="line">ms-dns 8.8.4.4</div></pre></td></tr></table></figure></p>
<p>解释: 设置链接到vpn的用户如果访问网络时使用的dns, 和他们自己电脑与服务器设置的dns没任何关系.</p>
<h3 id="VPN账号和密码"><a href="#VPN账号和密码" class="headerlink" title="VPN账号和密码"></a>VPN账号和密码</h3><p>编辑 <code>/etc/ppp/chap-secrets</code>，直接输入如下字段,vpsma可以换成其他字段，<br>格式: <code>用户名 pptpd 密码 IP</code> 的形式编写，如果需要多个账号就写多行，一行一个<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test </span>pptpd 1234 *</div></pre></td></tr></table></figure></p>
<p>解释: 这是链接vpn的用户密码, 每行一个, 代表一个用户.<br>格式说明: 第一列为用户, 依次是 服务器名称, 密码和ip, 中间使用一个空格或者tab隔开.<br>用户和密码可随意。服务器名(pptpd)不要改,如果修改请保证和<code>/etc/pptpd.conf</code>中的<code>name</code> 保持一致。后面的*代表ip由pptpd自动分配</p>
<h3 id="开启ip转发"><a href="#开启ip转发" class="headerlink" title="开启ip转发"></a>开启ip转发</h3><p>编辑 <code>/etc/sysctl.conf</code> 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将“net.ipv4.ip_forward”改为1，开启ip转发。这个不是必须的</span></div><div class="line">net.ipv4.ip_forward=1</div><div class="line"><span class="comment">#同时注释掉 “net.ipv4.tcp_syncookies = 1” (前面加#)</span></div><div class="line"><span class="comment"># net.ipv4.tcp_syncookies = 1</span></div><div class="line"></div><div class="line"><span class="comment">#保存退出`sysctl.conf`文件编辑后，运行下面的命令，能让设置立即生效 </span></div><div class="line">sysctl -p</div></pre></td></tr></table></figure></p>
<h3 id="配置完成后，重启pptpd服务并设置pptpd开机自启动"><a href="#配置完成后，重启pptpd服务并设置pptpd开机自启动" class="headerlink" title="配置完成后，重启pptpd服务并设置pptpd开机自启动"></a>配置完成后，重启pptpd服务并设置pptpd开机自启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">service pptpd start</div><div class="line">systemctl enabled pptpd</div><div class="line"></div><div class="line"><span class="comment">#启动服务后，可能通过系统日志查看运行情况</span></div><div class="line">tailf /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure>
<h2 id="iptables-配置"><a href="#iptables-配置" class="headerlink" title="iptables 配置"></a>iptables 配置</h2><h3 id="iptables-命令知识"><a href="#iptables-命令知识" class="headerlink" title="iptables 命令知识"></a>iptables 命令知识</h3><p>ipdables 配置文件位于 <code>/etc/sysconfig/iptables</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#带行号查看当前所有规则 </span></div><div class="line">iptables -L -n --line-numbers</div><div class="line"><span class="comment">#清除所有规则</span></div><div class="line">iptables -F</div><div class="line"><span class="comment">#删除指定行号（以下命令中的“5”为指定行号）规则</span></div><div class="line">iptables -D 5</div><div class="line"><span class="comment">#保存当前配置;相当于旧版/etc/init.d/iptables save</span></div><div class="line">service iptables save</div><div class="line"><span class="comment">#重启iptables;相当于旧版本/etc/init.d/iptables restart</span></div><div class="line">service iptables restart</div><div class="line"><span class="comment">#注册iptables服务;相当于旧版 chkconfig iptables on</span></div><div class="line">systemctl <span class="built_in">enable</span> iptables.service</div><div class="line"><span class="comment">#开启服务</span></div><div class="line">systemctl start iptables.service</div><div class="line"><span class="comment">#查看状态</span></div><div class="line">systemctl status iptables.service</div></pre></td></tr></table></figure>
<h3 id="允许连接PPTP服务-1723为pptp服务端口"><a href="#允许连接PPTP服务-1723为pptp服务端口" class="headerlink" title="允许连接PPTP服务,1723为pptp服务端口"></a>允许连接PPTP服务,1723为pptp服务端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport 1723 -j ACCEPT</div><div class="line">iptables -A INPUT -p tcp -m state --state NEW,RELATED,ESTABLISHED -m tcp --dport 1723 -j ACCEPT</div></pre></td></tr></table></figure>
<h3 id="允许建立VPN隧道-否则无法验证用户名及密码"><a href="#允许建立VPN隧道-否则无法验证用户名及密码" class="headerlink" title="允许建立VPN隧道,否则无法验证用户名及密码"></a>允许建立VPN隧道,否则无法验证用户名及密码</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT -p gre -j ACCEPT</div><div class="line">iptables -A INPUT -p gre -m <span class="keyword">state</span> --state NEW,RELATED,ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure>
<h3 id="建立NAT转换规则-否则拨上也无法通过远程网关连上公网"><a href="#建立NAT转换规则-否则拨上也无法通过远程网关连上公网" class="headerlink" title="建立NAT转换规则,否则拨上也无法通过远程网关连上公网"></a>建立NAT转换规则,否则拨上也无法通过远程网关连上公网</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这里一定看清楚，里面的ip“192.168.1.0/24”要和 /etc/pptpd.conf 的“localip”配置网段对应，还要注意网卡eth0，如果你的网卡不是eth0，就改成你相应的网卡名</span></div><div class="line"></div><div class="line"><span class="comment">#OpenVZ系统用此命令,1.1.1.1为你的VPS的IP地址</span></div><div class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to 1.1.1.1</div><div class="line"></div><div class="line"><span class="comment">#XEN系统用这个命令</span></div><div class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure>
<h3 id="如果某些网站不能访问，加上"><a href="#如果某些网站不能访问，加上" class="headerlink" title="如果某些网站不能访问，加上"></a>如果某些网站不能访问，加上</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --<span class="built_in">set</span>-mss 1356</div></pre></td></tr></table></figure>
<h4 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h4><p>linux下pptp搭建的vpn代理上网很慢解决方法。<br>在pptp所在的linux服务的iptables的*filter表中加入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --<span class="built_in">set</span>-mss 1356</div></pre></td></tr></table></figure></p>
<p>或者在命令提示符运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables -I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --<span class="built_in">set</span>-mss 1356</div></pre></td></tr></table></figure></p>
<p>拨通vpn，在服务器上用netstat –i查看接口，得到<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Iface MTU Met RX-OK RX-ERR RX-DRP RX-OVR TX-OK TX-ERR TX-DRP TX-OVR Flg</div><div class="line">eth0 1500 0 102528561 0 0 0 194391413 0 0 0 BRU</div><div class="line">eth1 1500 0 519820535 954 11553 924 208798037 0 0 0 BRU</div><div class="line">lo 16436 0 151062 0 0 0 151062 0 0 0 LRU</div><div class="line">ppp0 1396 0 19 0 0 0 8 0 0 0 OPRU</div></pre></td></tr></table></figure></p>
<p>可知ppp的最大mtu为1396，当然，对应的mss应为（mtu-20字节的IP头部+20字节的TCP 头部=）1356</p>
<ul>
<li>1、计算机网络中的MSS：<br>MSS: Maximum Segment Size 最大分段大小<br>MSS最大传输大小的缩写，是TCP协议里面的一个概念。</li>
</ul>
<p>MSS就是TCP数据包每次能够传输的最大数据分段。为了达到最佳的传输效能，TCP协议在建立连接的时候通常要协商双方的MSS值，这个值TCP协议在实现的时候往往用MTU值代替（需要减去IP数据包包头的大小20Bytes和TCP数据段的包头20Bytes）所以往往MSS为1460。通讯双方会根据双方提供的MSS值得最小值确定为这次连接的最大MSS值。</p>
<ul>
<li>2、mtu是网络传输最大报文包。<br>mss是网络传输数据最大值。mss加包头数据就等于mtu.<br>简单说拿TCP包做例子。<br>报文传输1400字节的数据的话，那么mss就是1400，再加上20字节IP包头，20字节tcp包头，那么mtu就是1400+20+20.</li>
</ul>
<p>当然传输的时候其他的协议还要加些包头在前面，总之mtu就是总的最后发出去的报文大小。mss就是你需要发出去的数据大小。</p>
<p>假设PC建立了到SERVER的HTTP连接，PC希望从SERVER下载一个大的网页。SERVER接收到PC的请求后开始发送大网页文件，其IP的DF位置1，不允许分片，IP报文长度为1500字节。到达VPN网关2的外网口（以太）后，VPN网关2发现其长度超过了1500个字节，于是将其丢弃，并给SERVER发回一个目的地址不可达的ICMP信息，同时指出“MTU of next hop: 1500”。PC接收到该消息后，又按照1500字节对外发送，又被丢弃，于是就形成了循环，无法通讯。</p>
<p>根据上述的分析，很容易得到如下解决方式，在VPN网关2的出接口设置MTU为1500－4－20＝1476，这样VPN网关2返回ICMP不可达消息时将给出”MTU of next hop: 1476”。SERVER将以1476作为自己的最大MTU对外发送，到达VPN网关1，封装GRE和外层IP头后就不会超过1500而顺利发到对端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --<span class="built_in">set</span>-mss 1356</div></pre></td></tr></table></figure>
<p>因为mss是在TCP连接建立开始时，通过带有syn标志的IP数据包进行传输的，所以我们在iptables里面规定，在转发数据时，只要发现产生于ppt<em>的带有 syn标志数据包时，将其mss设定为1356字节，这样就与ppp0接口的路径MTU向匹配了，数据自然就可以畅通无阻啦。<br>（注，vpn拨入一个，则建立一个ppt</em>的虚拟设备，这个可以再linux上用ifcpnfig看到，第一个为ppp1，第二个为ppp2……）</p>
<ul>
<li>3、在iptables里面加入一条规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -p tcp --syn -s 10.87.200.0/31 -j TCPMSS --<span class="built_in">set</span>-mss 1356</div></pre></td></tr></table></figure>
<p>因为mss是在TCP连接建立开始时，通过带有syn标志的IP数据包进行传输的，所以我们在iptables里面规定，在转发数据时，只要发现带有 syn标志并且源地址为主机B的IP数据包时，将其mss设定为1356字节，这样就与ppp0接口的路径MTU向匹配了，数据自然就可以畅通无阻啦。</p>
<p>因为mss是在TCP连接建立开始时，通过带有syn标志的IP数据包进行传输的，所以我们在iptables里面规定，在转发数据时，只要发现带有 syn标志并且源地址为主机B的IP数据包时，将其mss设定为1356字节，这样就与ppp0接口的路径MTU向匹配了，数据自然就可以畅通无阻啦。</p>
<h2 id="此次在实际-CentOS-环境中完整配置规则"><a href="#此次在实际-CentOS-环境中完整配置规则" class="headerlink" title="此次在实际 CentOS 环境中完整配置规则"></a>此次在实际 CentOS 环境中完整配置规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="comment">#允许连接PPTP服务</span></div><div class="line">iptables -I INPUT -p tcp --dport 1723 -j ACCEPT</div><div class="line"><span class="comment">#允许建立VPN隧道以验证用户名密码</span></div><div class="line">iptables -I INPUT -p gre -j ACCEPT</div><div class="line"><span class="comment">#建立NAT转换规则</span></div><div class="line">iptables -t nat -I POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE</div><div class="line"><span class="comment">#允许pptpd转发</span></div><div class="line">iptables -I FORWARD -i ppp+ -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT</div><div class="line"><span class="comment">#优化网络数据传输速度</span></div><div class="line">iptables -I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --<span class="built_in">set</span>-mss 1356</div><div class="line"><span class="built_in">echo</span> <span class="string">"完成"</span></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/10/20/react_babal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/20/react_babal/" itemprop="url">Babel CLI 安装及使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本地项目部分页面使用 react ,通常就是一两个jsx文件需要编译。所以不打算使用 webpack 等打包工具。只需要最简单的能通过命令行编译 ES6 语法编写的 jsx 源文件为普通js文件</p>
<h2 id="Babel-CLI-的安装"><a href="#Babel-CLI-的安装" class="headerlink" title="Babel CLI 的安装"></a>Babel CLI 的安装</h2><p>在官方网站安装说明部分，建议安装 babel CLI 使用本地方式，而非全局方式。一是因为本地开发中，各个项目依赖的 Babel 版本不尽相同，另外一方面是让项目更加独立，不依赖于具体的机器环境</p>
<p>There are two primary reasons for this.</p>
<ul>
<li>Different projects on the same machine can depend on different versions of Babel allowing you to update one at a time.</li>
<li>It means you do not have an implicit dependency on the environment you are working in. Making your project far more portable and easier to setup.</li>
</ul>
<p>在项目根目录中运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install --save-dev babel-cli babel-preset-latest</div></pre></td></tr></table></figure></p>
<p>因为全局安装运行 Babel 弊大于利，如果你之前已经全局安装过 Babel,可以使用如下命令卸载全局的 Babel<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">npm</span> uninstall --<span class="built_in">global</span> babel-cli</div></pre></td></tr></table></figure></p>
<h2 id="使用-ES6-开发-React-需要安装的其它模块"><a href="#使用-ES6-开发-React-需要安装的其它模块" class="headerlink" title="使用 ES6 开发 React 需要安装的其它模块"></a>使用 ES6 开发 React 需要安装的其它模块</h2><ul>
<li>babel-preset-es2015 （ES2015(ES6) 语法转换支持）</li>
<li>babel-preset-react （JSX 语法转换支持）</li>
</ul>
<p>在项目根目录中运行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ npm install --save-dev babel-preset-es2015</div><div class="line">$ npm install --save-dev babel-preset-react</div></pre></td></tr></table></figure></p>
<h2 id="监听并实时编译指定文件"><a href="#监听并实时编译指定文件" class="headerlink" title="监听并实时编译指定文件　"></a>监听并实时编译指定文件　</h2><p>准备工具完成后，我们可以开始编写代码了。在代码编写过程中，通过如下命令实时监控代码变动并编译生成转换文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">babel 源文件名 --watch --presets es2015,react --out-file 转换后的文件名</div></pre></td></tr></table></figure></p>
<p>我们也可以使用如下命令，将 src 目录下的所有文件编译到 lib 目录下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">babel src --watch --presets es2015,react  --out-dir lib</div></pre></td></tr></table></figure></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://www.csdn.net/article/2015-11-17/2826233" target="_blank" rel="external">走进Babel 6.0 全新特性解析</a></li>
<li><a href="http://blog.csdn.net/windfromcn/article/details/51307153" target="_blank" rel="external">Babel5 升级到 Babel6 总结</a></li>
<li><a href="http://babeljs.io/" target="_blank" rel="external">bablejs 官网</a></li>
<li><a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ECMAScript 6 入门</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/10/13/在多机部署时Yii的assetManager资源发布目录不一致问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/13/在多机部署时Yii的assetManager资源发布目录不一致问题/" itemprop="url">在多机部署时 Yii 的 assetManager 资源发布目录不一致问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Yii 提供了 <a href="https://github.com/yiisoft/yii2/blob/master/framework/web/AssetManager.php" target="_blank" rel="external">assetManager</a> 来管理相对独立的资源内容，通过 assetManager 可以很方便地将相关功能的 js，css，图片等资源进行管理和二次发布。当我们的资源放置位置不是位于网络可访问目录中时，Yii 的 assetManager 会自动将这些资源自动发布到 @web/assets 目录中，并且随机生成一个资源文件夹名称。当我们的程序是单机部署时，没有问题。而当我们进行多机部署时，会发现在在每台机器上生成的资源文件夹名称不一致的情况。这将导致页面上部分资源文件无法加载，报 404 错误。</p>
<p>为了解决这个问题，我们先来看一下 Yii2 中关于资源文件夹目录名称生成的源码片断（文件位于　<code>web/AssetManager.php</code>）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">publish</span><span class="params">($path, $options = [])</span></span></div><div class="line">&#123;</div><div class="line">    $path = Yii::getAlias($path);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_published[$path])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_published[$path];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!is_string($path) || ($src = realpath($path)) === <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidParamException(<span class="string">"The file or directory to be published does not exist: $path"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_file($src)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_published[$path] = <span class="keyword">$this</span>-&gt;publishFile($src);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_published[$path] = <span class="keyword">$this</span>-&gt;publishDirectory($src, $options);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Yii内部，资源发布的时候调用的就是这个 <a href="https://github.com/yiisoft/yii2/blob/master/framework/web/AssetManager.php#L443" target="_blank" rel="external">publish</a>  函数，可以看到，这里面主要有两个相关函数 <a href="https://github.com/yiisoft/yii2/blob/master/framework/web/AssetManager.php#L468" target="_blank" rel="external">publishFile</a> 和 <a href="https://github.com/yiisoft/yii2/blob/master/framework/web/AssetManager.php#L513" target="_blank" rel="external">publishDirectory</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">publishFile</span><span class="params">($src)</span></span></div><div class="line">&#123;</div><div class="line">    $dir = <span class="keyword">$this</span>-&gt;hash($src);</div><div class="line">    $fileName = basename($src);</div><div class="line">    $dstDir = <span class="keyword">$this</span>-&gt;basePath . DIRECTORY_SEPARATOR . $dir;</div><div class="line">    $dstFile = $dstDir . DIRECTORY_SEPARATOR . $fileName;</div><div class="line">    <span class="keyword">if</span> (!is_dir($dstDir)) &#123;</div><div class="line">        FileHelper::createDirectory($dstDir, <span class="keyword">$this</span>-&gt;dirMode, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;linkAssets) &#123;</div><div class="line">        <span class="keyword">if</span> (!is_file($dstFile)) &#123;</div><div class="line">            symlink($src, $dstFile);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">elseif</span> (@filemtime($dstFile) &lt; @filemtime($src)) &#123;</div><div class="line">        copy($src, $dstFile);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fileMode !== <span class="keyword">null</span>) &#123;</div><div class="line">            @chmod($dstFile, <span class="keyword">$this</span>-&gt;fileMode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [$dstFile, <span class="keyword">$this</span>-&gt;baseUrl . <span class="string">"/$dir/$fileName"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">publishDirectory</span><span class="params">($src, $options)</span></span></div><div class="line">&#123;</div><div class="line">    $dir = <span class="keyword">$this</span>-&gt;hash($src);</div><div class="line">    $dstDir = <span class="keyword">$this</span>-&gt;basePath . DIRECTORY_SEPARATOR . $dir;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;linkAssets) &#123;</div><div class="line">        <span class="keyword">if</span> (!is_dir($dstDir)) &#123;</div><div class="line">            FileHelper::createDirectory(dirname($dstDir), <span class="keyword">$this</span>-&gt;dirMode, <span class="keyword">true</span>);</div><div class="line">            symlink($src, $dstDir);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>($options[<span class="string">'forceCopy'</span>]) || (<span class="keyword">$this</span>-&gt;forceCopy &amp;&amp; !<span class="keyword">isset</span>($options[<span class="string">'forceCopy'</span>])) || !is_dir($dstDir)) &#123;</div><div class="line">        $opts = array_merge(</div><div class="line">            $options,</div><div class="line">            [</div><div class="line">                <span class="string">'dirMode'</span> =&gt; <span class="keyword">$this</span>-&gt;dirMode,</div><div class="line">                <span class="string">'fileMode'</span> =&gt; <span class="keyword">$this</span>-&gt;fileMode,</div><div class="line">            ]</div><div class="line">        );</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($opts[<span class="string">'beforeCopy'</span>])) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;beforeCopy !== <span class="keyword">null</span>) &#123;</div><div class="line">                $opts[<span class="string">'beforeCopy'</span>] = <span class="keyword">$this</span>-&gt;beforeCopy;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $opts[<span class="string">'beforeCopy'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">($from, $to)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> strncmp(basename($from), <span class="string">'.'</span>, <span class="number">1</span>) !== <span class="number">0</span>;</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($opts[<span class="string">'afterCopy'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;afterCopy !== <span class="keyword">null</span>) &#123;</div><div class="line">            $opts[<span class="string">'afterCopy'</span>] = <span class="keyword">$this</span>-&gt;afterCopy;</div><div class="line">        &#125;</div><div class="line">        FileHelper::copyDirectory($src, $dstDir, $opts);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [$dstDir, <span class="keyword">$this</span>-&gt;baseUrl . <span class="string">'/'</span> . $dir];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过源码我们可以看到，这两个函数在生成随机目录名 <code>dir</code> 时实际上都调用了一个 <a href="https://github.com/yiisoft/yii2/blob/master/framework/web/AssetManager.php#L596" target="_blank" rel="external">hash</a>方法,让我们来看一下这个方法:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hash</span><span class="params">($path)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (is_callable(<span class="keyword">$this</span>-&gt;hashCallback)) &#123;</div><div class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;hashCallback, $path);</div><div class="line">    &#125;</div><div class="line">    $path = (is_file($path) ? dirname($path) : $path) . filemtime($path);</div><div class="line">    <span class="keyword">return</span> sprintf(<span class="string">'%x'</span>, crc32($path . Yii::getVersion()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里，应该能很明白的看到是什么原因导致了在多机器上部署会导致文件名不一致了。核心原因就在于 <code>filemtime($path)</code> 这个部分。filemtime() 函数的作用是返回文件内容上次的修改时间。多机器部署的时候，我们通常不能保证同一个文件在每台机器上的这个时间一致。所以导致最终计算出来的名称不一致。</p>
<p>现在让我们来看一下，如何解决这个问题，在上面的代码中，我们看到有一个 <code>hashCallBack</code> 属性，这个属性值是一个可执行的自定义资源目录生成函数。</p>
<p>解决方法一:　配置文件中全局设置 assetManager 组件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">components =&gt; [</div><div class="line">    <span class="string">'assetManager'</span> =&gt; [</div><div class="line">        <span class="string">'hashCallback'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($path)</span> </span>&#123;</div><div class="line">            $path = (is_file($path) ? dirname($path) : $path);</div><div class="line">            <span class="keyword">return</span> sprintf(<span class="string">'%x'</span>, crc32($path . Yii::getVersion()));</div><div class="line">        &#125;,</div><div class="line">    ],</div><div class="line">]</div></pre></td></tr></table></figure>
<p>解决方法一:　局部动态设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">Yii::$app-&gt;getAssetManager()-&gt;hashCallback = <span class="function"><span class="keyword">function</span> <span class="params">($path)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'datatable'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/05/20/React开发技术栈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/20/React开发技术栈/" itemprop="url">React开发技术栈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>React本身仅只是一个视图层的解决方案，真实项目中还需要配合其它库来进行开发。这里介绍的是一个可进行完整项目开发的技术栈。将介绍以下这些库及它们之间如何配合来完成一个完整的项目开发。</p>
<ul>
<li><a href="https://facebook.github.io/react/" target="_blank" rel="external">react</a> 处理视图</li>
<li><a href="https://github.com/reactjs/react-router" target="_blank" rel="external">react-router</a> 前端路由</li>
<li><a href="http://redux.js.org/" target="_blank" rel="external">redux</a> 应用状态管理，即数据获取及处理</li>
<li><a href="https://github.com/reactjs/react-redux" target="_blank" rel="external">react-redux</a> react官方redux绑定</li>
<li><a href="https://github.com/gaearon/redux-thunk" target="_blank" rel="external">redux-thunk</a>　扩展redux,方便处理异步请求</li>
</ul>
<h2 id="react"><a href="#react" class="headerlink" title="react"></a>react</h2><p>react的核心是组件，了解组件的核心是搞清楚组件生命周期。组件之后，需要了解的是react组件之间信息流的传递，主要是通过<code>props</code>(包含回调函数，组件渲染所需要的数据等)</p>
<p>组件定义，组件通过 React.createClass()创建，包含以下一些定义</p>
<ul>
<li>render()</li>
<li>getInitialState()</li>
<li>getDefaultProps()</li>
<li>propTypes</li>
<li>mixins</li>
<li>statics</li>
</ul>
<p>react组件生命周期函数：</p>
<ul>
<li>componentWillMount()</li>
<li>componentDidMount()</li>
<li>componentWillReceiveProps()</li>
<li>shouldComponentUpdate()</li>
<li>componentWillUpdate()</li>
<li>componentDidUpdate()</li>
<li>componentWillUnmount()</li>
</ul>
<p>包含所有定义和生命周期函数的组件定义看起来像下面这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> Home = React.createClass(&#123;</div><div class="line">    <span class="attr">mixins</span>:[],</div><div class="line">    <span class="attr">statics</span>: &#123;&#125;,</div><div class="line">    <span class="attr">propTypes</span>:&#123;&#125;,</div><div class="line">    <span class="attr">getInitialState</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">getDefaultProps</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentWillMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentDidMount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentWillReceiveProps</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">shouldComponentUpdate</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentWillUpdate</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentDidUpdate</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</div><div class="line">    <span class="attr">componentWillUnmount</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>ES6</code>的写法略有不同，看起来像这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">Reac</span>.<span class="title">Component</span></span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(props)&#123;</div><div class="line">        <span class="keyword">super</span>(props);</div><div class="line">        <span class="keyword">this</span>.state = &#123;&#125;; <span class="comment">//取代getDefaultState()</span></div><div class="line">    &#125;</div><div class="line">    render()&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p>没有太多学习成本，主要功能就是提供路由和组件的绑定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ReactDOM.render((</div><div class="line">    &lt;Router history=&#123;history&#125;&gt;</div><div class="line">            &lt;Route path="/" component=&#123;App&#125;&gt;</div><div class="line">                &lt;IndexRoute component=&#123;Home&#125;/&gt;</div><div class="line">                &lt;Route path="about" component=&#123;About&#125;/&gt;</div><div class="line">            &lt;/Route&gt;</div><div class="line">            &lt;Route path="/other" component=&#123;Other&#125;&gt;</div><div class="line">    &lt;/Router&gt;</div><div class="line">), document.getElementById('react-content'))</div></pre></td></tr></table></figure>
<p>解释，上面的代码定义了一个路由规则</p>
<ul>
<li>访问　<code>/</code>　路径的时候，渲染Home组件</li>
<li>访问　<code>/about</code> 路径的时候，渲染About组件</li>
<li>访问 <code>/other</code>　路径的时候，渲染Other组件</li>
</ul>
<p>需要注意到<code>Home</code>和<code>About</code>被包含在App组件中，这样定义实现的效果是，<code>Home</code>和<code>About</code>组件的渲染会包裹在App组件中，实际上相当于我们平时开发流程中使用的<code>layout</code>视图层，这里的<code>App</code>组件就相当于<code>Home</code>和<code>About</code>的<code>layout</code>。来看一下App组件的render()方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div&gt;</div><div class="line">          &lt;Header/&gt;</div><div class="line">          &#123;this.props.children&#125;</div><div class="line">          &lt;Footer/&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码，在App组件中，我们通过 <code>this.props.children</code> 来获取当前路由对应的子组件（本例中的Home或About）,可以看出，在App组件中，我们还增加了<code>Header</code>和<code>Footer</code>两个组件，给<code>About</code>和<code>Home</code>加上了页头页尾</p>
<p>另外需要注意的是<code>history</code>这个<code>props</code>,它有三个选项</p>
<ul>
<li>browserHistory 基于浏览器URL(使链接更有意义，符合通常的认识，一般需要服务端支持url重写)</li>
<li>hashHistory 基于url的hash值(url中<code>#</code>之后的部分)</li>
<li>createMemoryHistory</li>
</ul>
<p>其它常用的组件:</p>
<ul>
<li><code>&lt;Link&gt;</code></li>
<li><code>&lt;Redirect&gt;</code></li>
</ul>
<p>以上是简单介绍，更多信息可访问<a href="https://github.com/reactjs/react-router/blob/master/docs/API.md" target="_blank" rel="external">官方文档</a>，查看说明</p>
<h2 id="redux-和-react-redux"><a href="#redux-和-react-redux" class="headerlink" title="redux 和 react-redux"></a>redux 和 react-redux</h2><p>redux是JavaScript状态容器,用于管理应用的状态（个人理解实际就是应用的数据和引起数据变更的操作，在react应用开发里，就是指定渲染react组件需要的数据和各种回调函数）</p>
<p>redux基础概念</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a><a href="http://cn.redux.js.org/docs/api/index.html" target="_blank" rel="external">API</a></h3><ul>
<li>createStore</li>
<li>Store</li>
<li>combineReducers</li>
<li>applyMiddleware</li>
<li>bindActionCreators</li>
<li>compose</li>
</ul>
<h3 id="state"><a href="#state" class="headerlink" title="state"></a>state</h3><p>前端各种组件在特定的state下渲染会有所不同，一个展示组件就是通过state的变化来渲染界面的。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">state = &#123;</div><div class="line"><span class="symbol">    todoReducer:</span> &#123;</div><div class="line"><span class="symbol">        todos:</span> [</div><div class="line">            &#123;<span class="string">text:</span><span class="string">'还书'</span>,<span class="string">completed:</span> <span class="literal">false</span>&#125;,</div><div class="line">            &#123;<span class="string">text:</span><span class="string">'买菜'</span>,<span class="string">completed:</span> <span class="literal">true</span>&#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>Store就是用来维持应用所有的state树的一个对象。应用的所有state以单一的对象存在一个单一的store中.可以理解为应用的数据库,存放渲染应用需要的所有数据。通过dispatch一个action来修改store中的state</p>
<p>Store对象的方法</p>
<ul>
<li>getState() 返回应用当前的 state 树。</li>
<li>dispatch(action) 分发 action。这是触发 state 变化的惟一途径</li>
<li>subscribe(listener) 添加一个变化监听器。每当 dispatch action 的时候就会执行，state 树中的一部分可能已经变化。你可以在回调函数里调用 getState() 来拿到当前 state。</li>
<li>replaceReducer(nextReducer) 替换 store 当前用来计算 state 的 reducer。</li>
</ul>
<h3 id="action"><a href="#action" class="headerlink" title="action"></a>action</h3><p>实际就是一个对像，必须包含一个<code>type</code>字段,<code>type</code>字段相当于定义了action的名字。通常长下面这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> ADD_TODO = <span class="string">"ADD_TODO"</span></div><div class="line">&#123;</div><div class="line">    <span class="attr">type</span>: ADD_TODO</div><div class="line">    text: <span class="string">''</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通常我们通过一个函数来封装action<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">todo</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">type</span>: ADD_TODO,</div><div class="line">        <span class="attr">text</span>: todo</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="reducers"><a href="#reducers" class="headerlink" title="reducers"></a>reducers</h3><p>实际就是回调函数的处理逻辑,响应的是<code>action</code>定义的操作，当<code>action</code>被调用的时候，触发指定的reducers函数，函数接受旧的state和action作为参数,返回一个新的state,新的state引起页面组件发生变化，从而使页面展示的信息发生变化</p>
<p>需要特别理解的是，reducers函数必须返回一个新的state对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">todoReducer</span>(<span class="params">state,action</span>)</span>&#123;</div><div class="line">        <span class="keyword">switch</span>(action.type)&#123;</div><div class="line">            <span class="keyword">case</span> ADD_TODO:</div><div class="line">                <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;<span class="attr">text</span>:action.text,<span class="attr">completed</span>:<span class="literal">false</span>&#125;); <span class="comment">//合并新的</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> state;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h3><p>有了<code>action</code>和<code>reducers</code>定义，那怎么把它们联系起来呢，这时候就要用到<code>dispatch</code>了。通常就是下面这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dispatch(&#123;</div><div class="line">    <span class="attr">type</span>: ADD_TODO,</div><div class="line">    <span class="attr">text</span>: <span class="string">'喝水'</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><code>dispatch</code> 的参数必须是一个<code>action</code> 对象（稍后会在react-thunk中再提到这个），调用<code>dispatch</code>后,指定的<code>reducers</code>将接收到这个调用，然后处理调用，返回新的状态。我们执行上面的<code>dispatch</code>后,state会变成下面这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">state = &#123;</div><div class="line">    <span class="attr">todoReducer</span>: &#123;</div><div class="line">        <span class="attr">todos</span>: [</div><div class="line">            &#123;<span class="attr">text</span>:<span class="string">'还书'</span>,<span class="attr">completed</span>: <span class="literal">false</span>&#125;,</div><div class="line">            &#123;<span class="attr">text</span>:<span class="string">'买菜'</span>,<span class="attr">completed</span>: <span class="literal">true</span>&#125;,</div><div class="line">            &#123;<span class="attr">text</span>:<span class="string">'喝水'</span>,<span class="attr">completed</span>: <span class="literal">false</span>&#125; <span class="comment">//这一行是新添加的</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="整体过一遍"><a href="#整体过一遍" class="headerlink" title="整体过一遍"></a>整体过一遍</h3><ul>
<li>定义好<code>action</code>和<code>reducers</code></li>
<li>通过将reducers传递给｀createStore（）｀来创建一个<code>store</code>对象</li>
<li>在应用中通过<code>dispatch</code>方法触发<code>action</code>,改变<code>state</code></li>
</ul>
<h3 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a>react-redux</h3><p>通过提供容器组件把sotre和dispatch绑定到真正展示用的组件中去</p>
<p>API</p>
<ul>
<li><code>&lt;Provider</code></li>
<li><code>connect()</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></div><div class="line"><span class="keyword">import</span> &#123;createStore&#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"><span class="keyword">import</span> &#123;Provider&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> todoReducer <span class="keyword">from</span> <span class="string">'./reducers/todoReducer'</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> store = createStore(todoReducer)</div><div class="line">ReactDOM.render((</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">App</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></div><div class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'react-content'</span>));</div></pre></td></tr></table></figure>
<p>上面的代码中，我们通过传入｀todoReducer｀给<code>redux库</code>的<code>createStore</code>API函数，创建了<code>App</code>组件的唯一｀store｀对象。<br>然后再通过｀react-redux｀的<code>Provider</code>组件使得<code>Provider</code>之下的组件都能通过 <code>connect()</code> 方法获得 Redux store。</p>
<p>在App组件中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Reactfrom <span class="string">'react'</span></div><div class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">'../pub/Header'</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></div><div class="line">          <span class="tag">&lt;<span class="name">Header</span>/&gt;</span></div><div class="line">          &#123;this.props.children&#125;</div><div class="line">          <span class="tag">&lt;<span class="name">Footer</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为App组件包裹在Provider之下，所以App下的Header组件也能通过connect获取store对象<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React, &#123;PropTypes&#125; <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123;initMenu&#125; <span class="keyword">from</span> <span class="string">'../actions/Action'</span></div><div class="line"><span class="keyword">import</span> MainMenu <span class="keyword">from</span> <span class="string">'./MainMenu'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Header</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  componentDidMount() &#123;</div><div class="line">    <span class="keyword">let</span> &#123;dispatch&#125; = <span class="keyword">this</span>.props.store</div><div class="line">    dispatch(addTodo())</div><div class="line">  &#125;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">header</span> <span class="attr">id</span>=<span class="string">"header"</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">store</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;<span class="attr">store</span>: store&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(Header)</div></pre></td></tr></table></figure></p>
<h2 id="react-thunk"><a href="#react-thunk" class="headerlink" title="react-thunk"></a>react-thunk</h2><p>上面谈<code>dispatch</code>的时候，我们说到，｀dispatch｀必须接受一个｀action｀对象作为参数，像如下这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">todo</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">type</span>: ADD_TODO,</div><div class="line">        <span class="attr">text</span>: todo</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>react-thunk是redux中间件，让<code>dispatch</code>能使用除了<code>action</code>以外的其它内容作为参数.比如下面的例子，我们定义一个fetchTodo函数，从某个远程接口获取一条todo数据，然后把这条数据通过dispatch添加到新的todo列表中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">todo</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">type</span>: ADD_TODO,</div><div class="line">        <span class="attr">text</span>: todo</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchTodo</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</div><div class="line">        $.get(<span class="string">"http://api.com/gettodo"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">todo</span>)</span>&#123;</div><div class="line">            dispatch(addTodo(todo));</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/05/20/nodejs_stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/20/nodejs_stack/" itemprop="url">Node开发技术栈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="package"><a href="#package" class="headerlink" title="package"></a>package</h3><ul>
<li><code>cross-env</code> 跨平台设置NODE_ENV</li>
</ul>
<p>package.json文件中命令设置环境变量时<br>windows 环境下报错: ‘NODE_ENV’ 不是内部或外部命令，也不是可运行的程序或批处理文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"start"</span>: <span class="string">" NODE_ENV=development webpack-dev-server --host 0.0.0.0 --devtool eval --progress --color --profile"</span>,</div><div class="line">    <span class="string">"deploy"</span>: <span class="string">"NODE_ENV=production webpack -p --progress"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>rimraf</code> nodejs版 rm -rf命令<br>尤其在window下，当删除node_modules文件夹时，会报目录层次太深删除报错的问题</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/05/19/Redux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/19/Redux/" itemprop="url">Redux概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Redux"><a href="#Redux" class="headerlink" title="Redux"></a>Redux</h1><h2 id="state"><a href="#state" class="headerlink" title="state"></a>state</h2><p>当前应用的数据状态，决定了UI应该如何展示，state变化通常将导致UI变化</p>
<h2 id="action"><a href="#action" class="headerlink" title="action"></a>action</h2><p>描述“发生了什么的”对象，用于数据传递。必须包含一个type字段用于表示将执行的动作.<br>通常被 store.dispatch()调用</p>
<p>例如以下action可用于描述id为42的文章被点赞这个行为<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">｛<span class="string">type:</span> <span class="string">'LIKE_ARTICLE'</span>, <span class="string">articleId:</span> <span class="number">42</span> &#125;;</div></pre></td></tr></table></figure></p>
<h2 id="reducer"><a href="#reducer" class="headerlink" title="reducer"></a>reducer</h2><p>计算数据，将变化的数据合并或去除，返回变化后的state。实际上就是响应store.dispatch()调用。<br>处理action返回新的state</p>
<h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><p>存放应用中所有的state，将action和reducer联系在一起。通过dispatch一个action触发reducer，从而改变应用的state</p>
<p>Store 有以下职责：</p>
<ul>
<li>维持应用的 state；</li>
<li>提供 getState() 方法获取 state；</li>
<li>提供 dispatch(action) 方法更新 state；</li>
<li>通过 subscribe(listener) 注册监听器。</li>
</ul>
<h2 id="Redux函数和react-redux组件"><a href="#Redux函数和react-redux组件" class="headerlink" title="Redux函数和react-redux组件"></a>Redux函数和react-redux组件</h2><h3 id="Redux-1"><a href="#Redux-1" class="headerlink" title="Redux"></a>Redux</h3><ul>
<li><p><code>createStore(reducer, [initialState])</code> 创建一个 Redux store 来以存放应用中所有的 state　　</p>
<ul>
<li><p>参数</p>
<ul>
<li><p>reducer (Function):</p>
<p>接收两个参数，分别是当前的 state 树和要处理的 action，返回新的 state 树。</p>
</li>
<li><p>[initialState] (any):</p>
<p>初始时的 state。在同构应用中，你可以决定是否把服务端传来的 state 水合（hydrate）后传给它，或者从之前保存的用户会话中恢复一个传给它。如果你使用 combineReducers 创建 reducer，它必须是一个普通对象，与传入的 keys 保持同样的结构。否则，你可以自由传入任何 reducer 可理解的内容。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>combineReducers(reducers)</code></p>
<p>  随着应用变得复杂，需要对 reducer 函数 进行拆分，拆分后的每一块独立负责管理 state 的一部分。</p>
<p>  combineReducers 辅助函数的作用是，把一个由多个不同 reducer 函数作为 value 的 object，合并成一个最终的 reducer 函数，然后就可以对这个 reducer 调用 createStore。</p>
<p>  合并后的 reducer 可以调用各个子 reducer，并把它们的结果合并成一个 state 对象。state 对象的结构由传入的多个 reducer 的 key 决定。</p>
</li>
</ul>
<h3 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a>react-redux</h3><ul>
<li><p><code>&lt;Provider store={}&gt;</code></p>
<p>  对组件注入<code>Redux Store</code></p>
</li>
<li><p>connect([mapStateToProps], [mapDispatchToProps], [mergeProps], [options])</p>
<p>连接 <code>React</code> 组件与 <code>Redux store</code></p>
<p>参数</p>
<ul>
<li><p>mapStateToProps(state, [ownProps]): stateProps</p>
<p> 如果定义该参数，组件将会监听 Redux store 的变化。任何时候，只要 Redux store 发生改变，mapStateToProps 函数就会被调用。该回调函数必须返回一个纯对象，这个对象会与组件的 props 合并。如果你省略了这个参数，你的组件将不会监听 Redux store。如果指定了该回调函数中的第二个参数 ownProps，则该参数的值为传递到组件的 props，而且只要组件接收到新的 props，mapStateToProps 也会被调用。</p>
</li>
<li><p>mapDispatchToProps(dispatch, [ownProps]): dispatchProps</p>
<p>如果传递的是一个对象，那么每个定义在该对象的函数都将被当作 Redux action creator，而且这个对象会与 Redux store 绑定在一起，其中所定义的方法名将作为属性名，合并到组件的 props 中。如果传递的是一个函数，该函数将接收一个 dispatch 函数，然后由你来决定如何返回一个对象，这个对象通过 dispatch 函数与 action creator 以某种方式绑定在一起（提示：你也许会用到 Redux 的辅助函数 bindActionCreators()）。如果你省略这个 mapDispatchToProps 参数，默认情况下，dispatch 会注入到你的组件 props 中。如果指定了该回调函数中第二个参数 ownProps，该参数的值为传递到组件的 props，而且只要组件接收到新 props，mapDispatchToProps 也会被调用。</p>
</li>
<li><p>mergeProps(stateProps, dispatchProps, ownProps): props</p>
<p>如果指定了这个参数，mapStateToProps() 与 mapDispatchToProps() 的执行结果和组件自身的 props 将传入到这个回调函数中。该回调函数返回的对象将作为 props 传递到被包装的组件中。你也许可以用这个回调函数，根据组件的 props 来筛选部分的 state 数据，或者把 props 中的某个特定变量与 action creator 绑定在一起。如果你省略这个参数，默认情况下返回 Object.assign({}, ownProps, stateProps, dispatchProps) 的结果。</p>
</li>
<li><p>options 如果指定这个参数，可以定制 connector 的行为。</p>
<ul>
<li><p>pure = true</p>
<p>如果为 true，connector 将执行 shouldComponentUpdate 并且浅对比 mergeProps 的结果，避免不必要的更新，前提是当前组件是一个“纯”组件，它不依赖于任何的输入或 state 而只依赖于 props 和 Redux store 的 state。默认值为 true。</p>
</li>
<li><p>withRef = false</p>
<p>如果为 true，connector 会保存一个对被包装组件实例的引用，该引用通过 getWrappedInstance() 方法获得。默认值为 false</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ul>
<li>使用Redux的createStore()创建一个包含了action和reducer的store</li>
<li>将应用根组件嵌套到react-redux的 <code>&lt;Provider store&gt;</code> 组件中，从页实现绑定</li>
<li>在应用根组件中使用react-redux的connect()实现连接，此时应用根组件的props可以接收到connect函数mapStateToProps参数中指定的store数据和方法</li>
</ul>
<h3 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h3><ul>
<li><a href="http://cn.redux.js.org" target="_blank" rel="external">http://cn.redux.js.org</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blog.sandy1890.com/2016/05/13/解决php的xdebug和composer冲突/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sandy1890">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安迪桑的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/13/解决php的xdebug和composer冲突/" itemprop="url">解决php的xdebug和composer冲突</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="composer"><a href="#composer" class="headerlink" title="composer"></a><a href="http://www.phpcomposer.com" target="_blank" rel="external">composer</a></h2><p>Composer 是 PHP 的一个依赖管理工具。它允许你申明项目所依赖的代码库，它会在你的项目中为你安装他们</p>
<h2 id="xdebug"><a href="#xdebug" class="headerlink" title="xdebug"></a><a href="https://xdebug.org" target="_blank" rel="external">xdebug</a></h2><p>Xdebug是一个开放源代码的PHP程序调试器(即一个Debug工具)，可以用来跟踪，调试和分析PHP程序的运行状况</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>如果php安装了xdebug扩展，当使用composer的时候，会有如下警告提示。提示信息里的连接给出了<a href="https://getcomposer.org/xdebug" target="_blank" rel="external">官方解决方案</a>　（这个地址竟然也被天朝墙，还让不让干活了）</p>
<p>引起的主要问题就是当你使用composer的时候，下载速度会被得奇慢无比</p>
<blockquote>
<p>You are running composer with xdebug enabled. This has a major impact on runtime performance. See <a href="https://getcomposer.org/xdebug" target="_blank" rel="external">https://getcomposer.org/xdebug</a></p>
</blockquote>
<p>官方的链接给出了以下几个解决方案</p>
<ul>
<li><p>禁用xdebug，在*nix系统下，再利用别名来使得命令行直接调用php可加载xdebug。通过以下两步实现</p>
<ul>
<li><p>php.ini配置里禁用xdebug</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">;zend_extension = <span class="string">"/path/to/my/xdebug.so"</span></div></pre></td></tr></table></figure>
</li>
<li><p>*nix系统里定义命令别名</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 直接调用php命令时加载xdebug</span></div><div class="line"><span class="built_in">alias</span> php=<span class="string">'php -dzend_extension=xdebug.so'</span></div><div class="line"><span class="comment"># PHPUnit需要使用xdebug.那么定义一个别名来处理</span></div><div class="line"><span class="built_in">alias</span> phpunit=<span class="string">'php $(which phpunit)'</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>新建一个禁用了xdebug的xdebug-disabled-php.ini文件，还是使用别名，将composer命令重新定义</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Without php.ini</span></div><div class="line"> <span class="built_in">alias</span> comp=<span class="string">'php -n /path/to/composer.phar'</span></div><div class="line"> <span class="comment"># Or with an xdebug-disabled php.ini</span></div><div class="line"> <span class="built_in">alias</span> comp=<span class="string">'php -c /path/to/xdebug-disabled-php.ini /path/to/composer.phar'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>…官方给出了另外的复杂方案，太麻烦，就不贴了，有兴趣到<a href="https://getcomposer.org/xdebug" target="_blank" rel="external">这里</a>自行查看</p>
<h2 id="我的解决方案"><a href="#我的解决方案" class="headerlink" title="我的解决方案"></a>我的解决方案</h2><p>针对Linux平台,因为我自己开发机器用的是php-fpm启动脚本</p>
<p>主要诉求是希望我机器上开机默认启动php的时候，能加载xdebug扩展，命令行下运行composer调用php命令的时候，不加载。解决思路是，在php.ini文件中禁用xdebug扩展，然后在php-fpm启动脚本中增加参数，加载xdeubg</p>
<p>具体操作就是直接修改启动脚本<code>/etc/init.d/php-fpm</code>下的参数,增加<code>-dzend_extension=xdebug.so</code>(注意，这里你可能需要传入xdebug.so文件的绝对路径)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php-fpm -dzend_extension=xdebug.so</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="sandy1890" />
          <p class="site-author-name" itemprop="name">sandy1890</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sandy1890</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
